@{
    ViewBag.Title = "Chat";
}
@Html.AntiForgeryToken()
<h2>Чат</h2>

<div class="container">
    <input type="text" id="message" />
    <input type="button" id="sendmessage" value="Послать сообщение" />
    <input type="hidden" id="displayname" />
    <ul id="discussion"></ul>

    <ul id="allUser"></ul>
    <input type="button" id="outChat" value="Выйти" />
    <input type="button" id="CheckServer" value="CheckServer" />
    <!--Обрезаем админскую версию чата, для обычного пользователя-->
    <!--<input type="button" id="hideChat" value="Скрыть сообщения выделенных пользователей" />-->
</div>
@section scripts {

    <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <script>

        // Сообщение в чат.
        function addMessageChat(name, message) {
            $('#discussion').append('<li id="' + htmlEncode(name) + '" role="msg"><strong>' + htmlEncode(name)
                + '</strong>: ' + htmlEncode(message) + '</li>');
        }
        $(function () {

            var chat = $.connection.chatHub;

            chat.client.addNewMessageToPage = function (name, message) {
                // Сообщение в чат.
                addMessageChat(name, message);

            };

            // Вошел пользователь.
            chat.client.addNewUser = function (name) {
                // Сообщение в чат.
                addMessageChat(name, "вошел пользователь: " + htmlEncode(name));
                /*
                $('#allUser').append('<li id=' + name + '><input type="checkbox" name="' + name + '" value="' + name + '" role="field"><strong> Пользователь: ' + htmlEncode(name)
                    + '</strong>: ' + '</li>');
                    */
                $('#allUser').append('<li id=' + name + '><strong> Пользователь: ' + htmlEncode(name)
                    + '</strong>: ' + '</li>');
            };

            // Вышел пользователь.
            chat.client.outUser = function (name) {
                // Add the message to the page.
                $('#discussion').append('<li><strong> вышел пользователь: ' + htmlEncode(name)
                    + '</strong>: ' + '</li>');

                $('#allUser [id=' + name + ']').hide();
            };

            var nameUser;
            // Ввод имени пользователя при заходе в чат.
            $('#displayname').val(nameUser = prompt('Введите ваше имя:', ''));


            $.connection.hub.start().done(function () {

                chat.server.inner(nameUser);
            });


            $('#message').focus();

            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {

                    chat.server.send(nameUser, $('#message').val());

                    $('#message').val('').focus();
                });
                $('#outChat').click(function () {

                    chat.server.out(nameUser);
                });
                $('#CheckServer').click(function () {

                    alert("Server");
                });
            });


            // Админ скрывает выбранных пользователей.
            $('#hideChat').click(function () {
                var user_ar = Array();
                $.each($('#allUser [role=field]'), function () {

                    // Скрыть пользователей, который указал админ.
                    if ($(this).prop("checked")) {
                        user_ar.push($(this).val());
                    }

                });

                // Показываем всех пользователей, срытых ранее, вдруг их надо опять показать.
                $.each($('#discussion [role=msg]'), function () {
                    $(this).show();
                });

                // Скрываем пользователей.
                for (var i = 0; i < user_ar.length; i++) {
                    $('#discussion [id=' + user_ar[i] + ']').hide();
                }

            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}